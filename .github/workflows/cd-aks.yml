name: ğŸš€ CD - Deploy para AKS

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Ambiente para deploy'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging

env:
  REGISTRY_NAME: escolaaksregistry
  CLUSTER_NAME: escola-aks
  RESOURCE_GROUP: escola-qapabilities-rg
  NAMESPACE: escola-qapabilities
  APP_NAME: student-service
  IMAGE_TAG: ${{ github.sha }}

jobs:
  build-and-push:
    name: ğŸ—ï¸ Build & Push Docker Image
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ” Login to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
        
    - name: ğŸ” Login to Azure Container Registry
      run: |
        az acr login --name ${{ env.REGISTRY_NAME }}
        
    - name: ğŸ—ï¸ Build and push Docker image
      run: |
        # Build da imagem
        docker build -t ${{ env.REGISTRY_NAME }}.azurecr.io/${{ env.APP_NAME }}:${{ env.IMAGE_TAG }} .
        docker build -t ${{ env.REGISTRY_NAME }}.azurecr.io/${{ env.APP_NAME }}:latest .
        
        # Push das imagens
        docker push ${{ env.REGISTRY_NAME }}.azurecr.io/${{ env.APP_NAME }}:${{ env.IMAGE_TAG }}
        docker push ${{ env.REGISTRY_NAME }}.azurecr.io/${{ env.APP_NAME }}:latest
        
    - name: ğŸ“Š Scan Docker image for vulnerabilities
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: ${{ env.REGISTRY_NAME }}.azurecr.io/${{ env.APP_NAME }}:${{ env.IMAGE_TAG }}
        format: 'sarif'
        output: 'trivy-image-results.sarif'
        
    - name: ğŸ“¤ Upload image scan results
      uses: github/codeql-action/upload-sarif@v2
      if: always()
      with:
        sarif_file: 'trivy-image-results.sarif'

  deploy-to-aks:
    name: ğŸš€ Deploy to AKS
    runs-on: ubuntu-latest
    needs: build-and-push
    environment: 
      name: ${{ github.event.inputs.environment || 'production' }}
      url: https://escola-aks.brazilsouth.cloudapp.azure.com
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ” Login to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
        
    - name: âš™ï¸ Setup kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'latest'
        
    - name: ğŸ”— Get AKS credentials
      run: |
        az aks get-credentials \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --name ${{ env.CLUSTER_NAME }} \
          --overwrite-existing
          
    - name: ğŸ“ Update Kubernetes manifests
      run: |
        # Atualizar a imagem no manifest
        sed -i "s|image: .*|image: ${{ env.REGISTRY_NAME }}.azurecr.io/${{ env.APP_NAME }}:${{ env.IMAGE_TAG }}|g" deploy-k8s.yaml
        
        # Adicionar labels para rastreamento
        sed -i "/metadata:/a\\  labels:\\n    app.kubernetes.io/version: \"${{ env.IMAGE_TAG }}\"\\n    github.com/sha: \"${{ github.sha }}\"\\n    github.com/run-id: \"${{ github.run_id }}\"" deploy-k8s.yaml
        
    - name: ğŸš€ Deploy to Kubernetes
      run: |
        # Aplicar os manifestos
        kubectl apply -f deploy-k8s.yaml
        
        # Aguardar o rollout
        kubectl rollout status deployment/${{ env.APP_NAME }} -n ${{ env.NAMESPACE }} --timeout=600s
        
    - name: âœ… Verify deployment
      run: |
        # Verificar pods
        kubectl get pods -n ${{ env.NAMESPACE }} -l app=${{ env.APP_NAME }}
        
        # Verificar services
        kubectl get services -n ${{ env.NAMESPACE }}
        
        # Verificar ingress
        kubectl get ingress -n ${{ env.NAMESPACE }}

  health-check:
    name: ğŸ¥ Health Check
    runs-on: ubuntu-latest
    needs: deploy-to-aks
    
    steps:
    - name: ğŸ” Login to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
        
    - name: âš™ï¸ Setup kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'latest'
        
    - name: ğŸ”— Get AKS credentials
      run: |
        az aks get-credentials \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --name ${{ env.CLUSTER_NAME }} \
          --overwrite-existing
          
    - name: ğŸ¥ Wait for application to be ready
      run: |
        echo "â³ Aguardando aplicaÃ§Ã£o ficar pronta..."
        kubectl wait --for=condition=ready pod -l app=${{ env.APP_NAME }} -n ${{ env.NAMESPACE }} --timeout=300s
        
    - name: ğŸ” Test health endpoint
      run: |
        # Port-forward para testar localmente
        kubectl port-forward service/${{ env.APP_NAME }} 8080:80 -n ${{ env.NAMESPACE }} &
        PF_PID=$!
        
        # Aguardar port-forward estar pronto
        sleep 10
        
        # Testar health check
        for i in {1..30}; do
          if curl -f http://localhost:8080/health; then
            echo "âœ… Health check passou!"
            kill $PF_PID
            exit 0
          fi
          echo "â³ Tentativa $i/30 - aguardando..."
          sleep 10
        done
        
        echo "âŒ Health check falhou apÃ³s 5 minutos"
        kill $PF_PID
        exit 1
        
    - name: ğŸ§ª Test API endpoints
      run: |
        # Port-forward para testar APIs
        kubectl port-forward service/${{ env.APP_NAME }} 8080:80 -n ${{ env.NAMESPACE }} &
        PF_PID=$!
        
        # Aguardar port-forward estar pronto
        sleep 10
        
        # Testar swagger
        if curl -f http://localhost:8080/swagger/index.html; then
          echo "âœ… Swagger estÃ¡ acessÃ­vel!"
        else
          echo "âŒ Swagger nÃ£o estÃ¡ acessÃ­vel"
          kill $PF_PID
          exit 1
        fi
        
        # Cleanup
        kill $PF_PID

  rollback-on-failure:
    name: ğŸ”„ Rollback on Failure
    runs-on: ubuntu-latest
    needs: [deploy-to-aks, health-check]
    if: failure()
    
    steps:
    - name: ğŸ” Login to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
        
    - name: âš™ï¸ Setup kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'latest'
        
    - name: ğŸ”— Get AKS credentials
      run: |
        az aks get-credentials \
          --resource-group ${{ env.RESOURCE_GROUP }} \
          --name ${{ env.CLUSTER_NAME }} \
          --overwrite-existing
          
    - name: ğŸ”„ Rollback deployment
      run: |
        echo "âŒ Deploy falhou, iniciando rollback..."
        kubectl rollout undo deployment/${{ env.APP_NAME }} -n ${{ env.NAMESPACE }}
        kubectl rollout status deployment/${{ env.APP_NAME }} -n ${{ env.NAMESPACE }} --timeout=300s
        echo "âœ… Rollback concluÃ­do"

  notify-success:
    name: ğŸ“¢ Notificar Sucesso
    runs-on: ubuntu-latest
    needs: [health-check]
    if: success()
    
    steps:
    - name: ğŸ‰ Deploy Success Notification
      run: |
        echo "ğŸ‰ Deploy realizado com sucesso!"
        echo "ğŸ“¦ Imagem: ${{ env.REGISTRY_NAME }}.azurecr.io/${{ env.APP_NAME }}:${{ env.IMAGE_TAG }}"
        echo "ğŸ·ï¸ SHA: ${{ github.sha }}"
        echo "ğŸ”— Run: ${{ github.run_id }}"
        echo "ğŸŒ URL: https://escola-aks.brazilsouth.cloudapp.azure.com"
