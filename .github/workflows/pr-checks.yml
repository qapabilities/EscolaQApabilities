name: ğŸ” PR Checks

on:
  pull_request:
    branches: [ main, develop ]
    types: [opened, synchronize, reopened]

env:
  DOTNET_VERSION: '8.0.x'

jobs:
  pr-validation:
    name: ğŸ” ValidaÃ§Ã£o do PR
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: âš™ï¸ Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: ğŸ”„ Restore dependencies
      run: dotnet restore
      
    - name: ğŸ—ï¸ Build
      run: dotnet build --no-restore --configuration Release
      
    - name: ğŸ§ª Run tests
      run: |
        dotnet test --no-build --configuration Release \
          --verbosity normal \
          --collect:"XPlat Code Coverage" \
          --logger trx \
          --results-directory ./TestResults
          
    - name: ğŸ“Š Test Report
      uses: dorny/test-reporter@v1
      if: success() || failure()
      with:
        name: '.NET Tests'
        path: './TestResults/*.trx'
        reporter: dotnet-trx
        
    - name: ğŸ“ PR Comment - Build Success
      if: success()
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## âœ… Build Status: SUCCESS
            
            ğŸ‰ **All checks passed!**
            
            - âœ… Build completed successfully
            - âœ… All tests passed
            - âœ… Code quality checks passed
            
            Ready for review! ğŸš€`
          });
          
    - name: ğŸ“ PR Comment - Build Failed
      if: failure()
      uses: actions/github-script@v6
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: `## âŒ Build Status: FAILED
            
            ğŸš¨ **Some checks failed!**
            
            Please check the workflow logs and fix the issues before merging.
            
            [View workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})`
          });

  docker-build-test:
    name: ğŸ³ Docker Build Test
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ—ï¸ Build Docker image
      run: |
        docker build -t escola-student-service:pr-${{ github.event.number }} .
        
    - name: ğŸ” Test Docker image
      run: |
        # Verificar se a imagem foi criada
        docker images escola-student-service:pr-${{ github.event.number }}
        
        # Teste bÃ¡sico de execuÃ§Ã£o
        docker run --rm --name test-container -d \
          -p 8080:8080 \
          -e ASPNETCORE_ENVIRONMENT=Development \
          -e STUDENT_DB_CONNECTION_STRING="Data Source=:memory:" \
          -e USE_SQLITE="true" \
          -e JWT_KEY="test-key-for-development-only-32-chars-minimum" \
          -e JWT_ISSUER="EscolaQApabilities" \
          -e JWT_AUDIENCE="EscolaQApabilitiesAPI" \
          -e JWT_EXPIRY_MINUTES="60" \
          escola-student-service:pr-${{ github.event.number }}
          
        # Aguardar container iniciar
        sleep 30
        
        # Testar health endpoint
        if curl -f http://localhost:8080/health; then
          echo "âœ… Container health check passou!"
        else
          echo "âŒ Container health check falhou!"
          docker logs test-container
          exit 1
        fi
        
        # Cleanup
        docker stop test-container

  changed-files:
    name: ğŸ“ Arquivos Alterados
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: ğŸ“ Get changed files
      id: changed-files
      uses: tj-actions/changed-files@v40
      with:
        files: |
          **/*.cs
          **/*.csproj
          **/*.sln
          **/Dockerfile
          **/*.yml
          **/*.yaml
          
    - name: ğŸ“ List changed files
      if: steps.changed-files.outputs.any_changed == 'true'
      run: |
        echo "ğŸ“ Arquivos alterados neste PR:"
        echo "${{ steps.changed-files.outputs.all_changed_files }}" | tr ' ' '\n'
