# ğŸ” PR Checks - Pull Request Validation
# Escola QApabilities - Student Service
# 
# Triggers: Pull Requests
# Jobs: Build validation, Docker build test, Auto-comments

name: PR Checks - Pull Request Validation

on:
  pull_request:
    branches: [ main, develop ]
    types: [opened, synchronize, reopened]

env:
  DOTNET_VERSION: '8.0.x'
  SOLUTION_FILE: 'EscolaQApabilities.StudentService.sln'

jobs:
  # ============================================================================
  # JOB 1: PR VALIDATION
  # ============================================================================
  pr-validation:
    name: ğŸ” PR Validation
    runs-on: ubuntu-latest
    
    steps:
    # Checkout do cÃ³digo
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Para comparar com branch base
        
    # Setup .NET 8
    - name: ğŸ”§ Setup .NET ${{ env.DOTNET_VERSION }}
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    # Cache de pacotes NuGet
    - name: ğŸ“¦ Cache NuGet packages
      uses: actions/cache@v4
      with:
        path: ~/.nuget/packages
        key: ${{ runner.os }}-nuget-${{ hashFiles('**/*.csproj') }}
        restore-keys: |
          ${{ runner.os }}-nuget-
          
    # Restore dependencies
    - name: ğŸ“¦ Restore Dependencies
      run: dotnet restore ${{ env.SOLUTION_FILE }}
      
    # Build da aplicaÃ§Ã£o
    - name: ğŸ—ï¸ Build Application
      run: dotnet build ${{ env.SOLUTION_FILE }} --no-restore --configuration Release
      
    # Executar testes unitÃ¡rios
    - name: ğŸ§ª Run Unit Tests
      run: |
        dotnet test ${{ env.SOLUTION_FILE }} \
          --no-build \
          --configuration Release \
          --verbosity normal \
          --collect:"XPlat Code Coverage" \
          --results-directory ./TestResults \
          --logger "trx;LogFileName=test-results.trx"
          
    # AnÃ¡lise de arquivos alterados
    - name: ğŸ“‹ Analyze Changed Files
      id: changed-files
      run: |
        echo "Analisando arquivos alterados no PR..."
        
        # Obter lista de arquivos alterados
        git diff --name-only origin/${{ github.base_ref }}..HEAD > changed_files.txt
        
        # Categorizar arquivos
        CSHARP_FILES=$(grep '\.cs$' changed_files.txt | wc -l)
        YAML_FILES=$(grep '\.ya?ml$' changed_files.txt | wc -l)
        DOCKER_FILES=$(grep -E '(Dockerfile|docker-compose)' changed_files.txt | wc -l)
        JSON_FILES=$(grep '\.json$' changed_files.txt | wc -l)
        
        echo "cs-files=$CSHARP_FILES" >> $GITHUB_OUTPUT
        echo "yaml-files=$YAML_FILES" >> $GITHUB_OUTPUT
        echo "docker-files=$DOCKER_FILES" >> $GITHUB_OUTPUT
        echo "json-files=$JSON_FILES" >> $GITHUB_OUTPUT
        
        # Salvar lista para comentÃ¡rio
        echo "## ğŸ“‹ Arquivos Alterados" > pr-summary.md
        echo "" >> pr-summary.md
        echo "| Tipo | Quantidade |" >> pr-summary.md
        echo "|------|------------|" >> pr-summary.md
        echo "| ğŸ”§ C# Files | $CSHARP_FILES |" >> pr-summary.md
        echo "| âš™ï¸ YAML Files | $YAML_FILES |" >> pr-summary.md
        echo "| ğŸ³ Docker Files | $DOCKER_FILES |" >> pr-summary.md
        echo "| ğŸ“„ JSON Files | $JSON_FILES |" >> pr-summary.md
        echo "" >> pr-summary.md
        
        if [ $CSHARP_FILES -gt 0 ]; then
          echo "### ğŸ”§ Arquivos C# Alterados:" >> pr-summary.md
          grep '\.cs$' changed_files.txt | sed 's/^/- /' >> pr-summary.md
          echo "" >> pr-summary.md
        fi
        
        if [ $DOCKER_FILES -gt 0 ]; then
          echo "### ğŸ³ Arquivos Docker Alterados:" >> pr-summary.md
          grep -E '(Dockerfile|docker-compose)' changed_files.txt | sed 's/^/- /' >> pr-summary.md
          echo "" >> pr-summary.md
        fi

  # ============================================================================
  # JOB 2: DOCKER BUILD TEST
  # ============================================================================
  docker-build-test:
    name: ğŸ³ Docker Build Test
    runs-on: ubuntu-latest
    if: contains(github.event.pull_request.changed_files, 'Dockerfile') || contains(github.event.pull_request.changed_files, 'docker-compose')
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    # Test build da imagem Docker
    - name: ğŸ³ Test Docker Build
      run: |
        echo "ğŸ³ Testando build da imagem Docker..."
        docker build -t escola-student-service:pr-test .
        
        echo "âœ… Docker build executado com sucesso!"
        
        # Verificar tamanho da imagem
        IMAGE_SIZE=$(docker images escola-student-service:pr-test --format "table {{.Size}}" | tail -n 1)
        echo "ğŸ“¦ Tamanho da imagem: $IMAGE_SIZE"
        
        # Adicionar ao summary
        echo "### ğŸ³ Docker Build Results" >> pr-summary.md
        echo "- âœ… Build: Successful" >> pr-summary.md
        echo "- ğŸ“¦ Image Size: $IMAGE_SIZE" >> pr-summary.md
        echo "" >> pr-summary.md
        
    # Test bÃ¡sico do container
    - name: ğŸ§ª Test Container Startup
      run: |
        echo "ğŸ§ª Testando inicializaÃ§Ã£o do container..."
        
        # Configurar variÃ¡veis mÃ­nimas para teste
        docker run -d \
          --name test-container \
          -e ASPNETCORE_ENVIRONMENT=Development \
          -e USE_SQLITE=true \
          -e STUDENT_DB_CONNECTION_STRING="Data Source=/tmp/test.db" \
          -e JWT_KEY="test-key-for-pr-validation-32-chars-minimum" \
          -p 8080:8080 \
          escola-student-service:pr-test
          
        # Aguardar container inicializar
        sleep 30
        
        # Verificar se container estÃ¡ rodando
        if docker ps | grep test-container; then
          echo "âœ… Container iniciado com sucesso!"
          
          # Verificar logs
          echo "ğŸ“‹ Logs do container:"
          docker logs test-container --tail 10
          
        else
          echo "âŒ Container falhou ao iniciar"
          docker logs test-container
          exit 1
        fi
        
        # Cleanup
        docker stop test-container
        docker rm test-container

  # ============================================================================
  # JOB 3: SECURITY SCAN (se Dockerfile alterado)
  # ============================================================================
  security-scan:
    name: ğŸ” Security Scan
    runs-on: ubuntu-latest
    needs: docker-build-test
    if: contains(github.event.pull_request.changed_files, 'Dockerfile')
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    - name: ğŸ³ Build Image for Scan
      run: docker build -t escola-student-service:security-scan .
      
    # Security scan com Trivy
    - name: ğŸ” Run Trivy Security Scan
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: 'escola-student-service:security-scan'
        format: 'table'
        output: 'trivy-results.txt'
        
    - name: ğŸ“‹ Security Summary
      run: |
        echo "### ğŸ” Security Scan Results" >> pr-summary.md
        echo "\`\`\`" >> pr-summary.md
        head -20 trivy-results.txt >> pr-summary.md
        echo "\`\`\`" >> pr-summary.md
        echo "" >> pr-summary.md

  # ============================================================================
  # JOB 4: AUTO COMMENT NO PR
  # ============================================================================
  pr-comment:
    name: ğŸ’¬ Auto Comment
    runs-on: ubuntu-latest
    needs: [pr-validation, docker-build-test]
    if: always()
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      
    # Gerar comentÃ¡rio automÃ¡tico
    - name: ğŸ“ Generate PR Comment
      run: |
        echo "# ğŸ¤– PR Validation Results" > pr-comment.md
        echo "" >> pr-comment.md
        echo "**PR:** #${{ github.event.number }}" >> pr-comment.md
        echo "**Branch:** \`${{ github.head_ref }}\` â†’ \`${{ github.base_ref }}\`" >> pr-comment.md
        echo "**Author:** @${{ github.event.pull_request.user.login }}" >> pr-comment.md
        echo "" >> pr-comment.md
        
        # Status dos jobs
        echo "## ğŸ¯ Validation Status" >> pr-comment.md
        echo "" >> pr-comment.md
        
        if [ "${{ needs.pr-validation.result }}" = "success" ]; then
          echo "- âœ… **Build & Tests**: Passed" >> pr-comment.md
        else
          echo "- âŒ **Build & Tests**: Failed" >> pr-comment.md
        fi
        
        if [ "${{ needs.docker-build-test.result }}" = "success" ]; then
          echo "- âœ… **Docker Build**: Passed" >> pr-comment.md
        elif [ "${{ needs.docker-build-test.result }}" = "skipped" ]; then
          echo "- â­ï¸ **Docker Build**: Skipped (no Docker changes)" >> pr-comment.md
        else
          echo "- âŒ **Docker Build**: Failed" >> pr-comment.md
        fi
        
        echo "" >> pr-comment.md
        
        # Adicionar summary se existir
        if [ -f pr-summary.md ]; then
          cat pr-summary.md >> pr-comment.md
        fi
        
        # PrÃ³ximos passos
        echo "## ğŸš€ Next Steps" >> pr-comment.md
        echo "" >> pr-comment.md
        
        if [ "${{ needs.pr-validation.result }}" = "success" ]; then
          echo "âœ… PR estÃ¡ pronto para review!" >> pr-comment.md
          echo "" >> pr-comment.md
          echo "ApÃ³s aprovaÃ§Ã£o e merge para \`main\`, serÃ¡ executado:" >> pr-comment.md
          echo "- ğŸ—ï¸ CI Pipeline completa" >> pr-comment.md  
          echo "- ğŸš€ Deploy automÃ¡tico para AKS" >> pr-comment.md
          echo "- ğŸ¥ Health checks pÃ³s-deploy" >> pr-comment.md
        else
          echo "âŒ Corrija os problemas encontrados antes do merge." >> pr-comment.md
        fi
        
        echo "" >> pr-comment.md
        echo "---" >> pr-comment.md
        echo "*ğŸ¤– ComentÃ¡rio gerado automaticamente pela pipeline de CI/CD*" >> pr-comment.md
        
    # Postar comentÃ¡rio no PR
    - name: ğŸ’¬ Comment PR
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const comment = fs.readFileSync('pr-comment.md', 'utf8');
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });

  # ============================================================================
  # JOB 5: PR SUMMARY
  # ============================================================================
  pr-success:
    name: âœ… PR Checks Complete
    runs-on: ubuntu-latest
    needs: [pr-validation, docker-build-test, pr-comment]
    if: success()
    
    steps:
    - name: ğŸ‰ PR Validation Success
      run: |
        echo "ğŸ‰ PR VALIDATION CONCLUÃDA COM SUCESSO!"
        echo ""
        echo "âœ… Build: OK"
        echo "âœ… Tests: OK"
        echo "âœ… Docker Build: OK"
        echo "âœ… Auto Comment: OK"
        echo ""
        echo "ğŸš€ PR estÃ¡ pronto para review e merge!"